<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Data App - Week {{ week_number }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --bg-color: #0d1117;
            --surface-color: #161b22;
            --header-bg: #21262d;
            --border-color: #30363d;
            --primary-text: #c9d1d9;
            --secondary-text: #8b949e;
            --accent-color: #58a6ff;
            --best-odd-bg: #234c31;
            --best-odd-text: #56d364;
            --profit-color: #56d364;
            --hover-color: #2a3038;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-radius: 6px;
            --indicator-up-color: #56d364;
            --indicator-down-color: #f85149;
        }

        html { scroll-behavior: smooth; }
        body { font-family: var(--font-family); margin: 0; background-color: var(--bg-color); color: var(--primary-text); }
        .dashboard-container { display: flex; max-width: 1600px; margin: 0 auto; }

        /* --- 1. Sidebar Navigation (Unchanged) --- */
        .sidebar { width: 280px; height: 100vh; position: sticky; top: 0; background-color: var(--surface-color); border-right: 1px solid var(--border-color); padding: 20px 0; overflow-y: auto; flex-shrink: 0; }
        .sidebar-header { padding: 0 20px 15px 20px; font-size: 1.2em; font-weight: bold; border-bottom: 1px solid var(--border-color); }
        .game-nav-list { list-style: none; padding: 0; margin: 10px 0 0 0; }
        .game-nav-item a { display: flex; align-items: center; gap: 10px; padding: 12px 20px; color: var(--secondary-text); text-decoration: none; font-size: 0.9em; border-left: 3px solid transparent; transition: all 0.2s; }
        .game-nav-item a:hover { background-color: var(--hover-color); color: var(--primary-text); }
        .game-nav-item a.active { background-color: #2d405d; color: #fff; font-weight: bold; border-left-color: var(--accent-color); }
        .game-nav-item.filtered-out { display: none; }
        .game-nav-logos { display: flex; align-items: center; }
        .game-nav-logos img, .game-nav-logos svg { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; background-color: #2a3038;}
        .game-nav-logos > *:first-child { margin-right: -8px; }
        .placeholder-icon { fill: var(--secondary-text); }

        /* --- 2. Main Content & Header Controls (Unchanged) --- */
        .main-content { flex-grow: 1; padding: 20px 30px; min-width: 0; }
        .page-header { margin-bottom: 25px; }
        .page-header h1 { margin: 0 0 20px 0; }
        .controls-container { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .search-box, .prop-select, .btn { padding: 8px 12px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--primary-text); font-size: 0.9em; }
        .btn { background-color: var(--accent-color); color: var(--bg-color); font-weight: bold; cursor: pointer; text-decoration: none; }
        .btn-secondary { background-color: var(--surface-color); color: var(--primary-text); }
        .week-selector-container { display: flex; align-items: center; gap: 8px; margin-left: auto; }
        .filter-dropdown-btn { -webkit-appearance: none; appearance: none; padding-right: 30px; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236e7681' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        .hidden { display: none; }

        /* --- 3. Arbitrage, Game & Team Containers (Unchanged) --- */
        .content-section { border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 25px; background-color: var(--surface-color); }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--header-bg); cursor: pointer;}
        .section-header h2 { margin: 0; font-size: 1.5em; }
        
        .toggle-icon { 
            font-size: 1.2em;
            transition: transform 0.3s ease-in-out; 
            transform: rotate(0deg); /* Default (collapsed) state is pointing right */
            line-height: 1;
        }
        .section-header:not(.collapsed) .toggle-icon { 
            transform: rotate(90deg); /* Expanded state points down */
        }

        .section-content { overflow: hidden; max-height: 5000px; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out; }
        .section-content.hidden { max-height: 0; padding: 0 20px; }
        .badge { background-color: var(--secondary-text); color: var(--bg-color); font-size: 0.7em; font-weight: bold; padding: 3px 8px; border-radius: 10px; margin-left: 10px; }
        #arbitrage-section .section-header .badge { background-color: var(--profit-color); }
        .game-section-header { cursor: default; }

        /* --- 4. Player Accordion & STICKY TABLE (Unchanged) --- */
        .team-header { padding: 15px 20px; font-size: 1.3em; font-weight: bold; border-top: 1px solid var(--border-color); background: #1a222e; }
        .player-accordion-item { border-top: 1px solid var(--border-color); }
        .player-header { display: flex; align-items: center; gap: 15px; padding: 12px 20px; cursor: pointer; transition: background-color 0.2s; }
        .player-header:hover { background-color: var(--hover-color); }
        
        .player-header .toggle-icon { 
            font-size: 1.1em; 
            transform: rotate(0deg); /* Default (collapsed) state */
            transition: transform 0.3s ease-out; 
        }
        .player-header.active .toggle-icon { 
            transform: rotate(90deg); /* Active (expanded) state */
        }

        .player-name { font-weight: bold; font-size: 1.1em; }
        .player-props-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: var(--bg-color); }
        
        .player-props-content .table-wrapper { padding: 15px; overflow-x: auto;}
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; min-width: 120px; }
        
        th:first-child, td:first-child,
        th:nth-child(2), td:nth-child(2) {
            position: sticky; z-index: 1; background-color: var(--bg-color);
        }
        th:first-child, td:first-child { left: 0; min-width: 180px; }
        th:nth-child(2), td:nth-child(2) { left: 180px; }
        td:nth-child(2) { border-right: 2px solid var(--border-color); }
        th:nth-child(2) { border-right: 2px solid var(--header-bg); }

        th { font-size: 0.8em; color: var(--secondary-text); background-color: var(--header-bg); z-index: 2; }
        .odds-cell { text-align: center; }
        .line { font-weight: bold; }
        .odds { font-size: 0.9em; color: var(--secondary-text); }
        .best-odd { background-color: var(--best-odd-bg); color: var(--best-odd-text); font-weight: bold; border-radius: 4px; padding: 2px 4px; }
        
        /* --- 5. (MODIFIED) History Modal --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--surface-color); margin: 5% auto; padding: 25px; border: 1px solid var(--border-color); width: 90%; max-width: 1000px; border-radius: var(--border-radius); box-shadow: 0 5px 20px rgba(0,0,0,0.5); animation: slide-down 0.3s ease-out; }
        @keyframes slide-down { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        #modalTitle { margin: 0; font-size: 1.4em; color: var(--primary-text); }
        .close-button { color: var(--secondary-text); font-size: 32px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-button:hover, .close-button:focus { color: var(--primary-text); }
        .modal-body { display: grid; grid-template-columns: 1fr; gap: 0; }

        /* --- 5a. (MODIFIED) Master Tab Styles --- */
        .main-tab-nav {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow tabs to wrap on small screens */
        }
        .main-tab-btn {
            padding: 10px 15px;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 1em;
            font-weight: 600;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            white-space: nowrap;
        }
        .main-tab-btn:hover { color: var(--primary-text); }
        .main-tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        
        .main-tab-pane { display: none; }
        .main-tab-pane.active { display: block; }
        
        /* --- 5b. (NEW) Pane Content Styles --- */
        .pane-chart-wrapper { /* (NEW) Holds the two detail charts */
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-title { /* (NEW) Title for the sub-charts */
            font-size: 0.9em;
            color: var(--secondary-text);
            text-align: center;
            margin-bottom: 10px;
        }
        .chart-container {
            position: relative; 
            height: 220px; /* (MODIFIED) Smaller height for sub-charts */
            background-color: var(--bg-color); 
            padding: 10px; 
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        /* (MODIFIED) Special style for the single comparison chart */
        #pane-Compare .chart-container {
             height: 350px;
             border: none;
             padding: 0;
             background: none;
        }
        /* (MODIFIED) Table wrapper is now inside the pane */
        .main-tab-pane .table-wrapper {
             max-height: 300px;
             overflow-y: auto;
             border: 1px solid var(--border-color);
             border-radius: var(--border-radius);
        }
        
        /* --- 5c. (MODIFIED) History Table --- */
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th, .history-table td { border-bottom: 1px solid var(--border-color); padding: 10px 14px; text-align: left; font-size: 0.9em; }
        .history-table th { background-color: var(--header-bg); position: sticky; top: 0; }
        .history-table tr:last-child td { border-bottom: none; }
        .history-btn { background-color: transparent; color: var(--accent-color); border: 1px solid var(--border-color); padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75em; margin-left: 10px; vertical-align: middle; }
        .history-btn:hover { background-color: var(--hover-color); }
        
        /* --- 5d. (Unchanged) Indicator Styles --- */
        .indicator { font-size: 0.8em; margin-left: 5px; display: inline-block; }
        .indicator-up { color: var(--indicator-up-color); }
        .indicator-down { color: var(--indicator-down-color); }

        @media (max-width: 768px) {
            .dashboard-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; position: relative; border-right: none; border-bottom: 1px solid var(--border-color); }
            .main-content { padding: 10px; }
            th:first-child, td:first-child, th:nth-child(2), td:nth-child(2) { position: static; }
            td:nth-child(2), th:nth-child(2) { border-right: none; }
            .pane-chart-wrapper { grid-template-columns: 1fr; } /* Stack charts on mobile */
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="sidebar-header">Games - Week {{ week_number }}</div>
            <ul class="game-nav-list">
                {% for game, game_data in final_data.items()|sort %}
                    <li class="game-nav-item" data-game-id="game-{{ loop.index }}">
                        <a href="#game-{{ loop.index }}">
                            <div class="game-nav-logos">
                                {% set logos = namespace(items=[]) %}
                                {% for team, t_data in game_data.teams.items() %}{% set logos.items = logos.items + [t_data.logo or 'placeholder'] %}{% endfor %}
                                {% for logo_url in logos.items[:2] %}
                                    {% if logo_url == 'placeholder' %}
                                        <svg class="placeholder-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,1.5A10.5,10.5,0,0,0,1.5,12A10.5,10.5,0,0,0,12,22.5A10.5,10.5,0,0,0,22.5,12A10.5,10.5,0,0,0,12,1.5M12,3A9,9,0,0,1,21,12C21,14.63,19.78,16.94,18,18.45V12A6,6,0,0,0,12,6A6,6,0,0,0,6,12V18.45C4.22,16.94,3,14.63,3,12A9,9,0,0,1,12,3M6,20A7.5,7.5,0,0,0,12,21A7.5,7.5,0,0,0,18,20V12A6,6,0,0,0,12,6A6,6,0,0,0,6,12V20Z"></path></svg>
                                    {% else %}
                                        <img src="{{ logo_url }}" alt="Team Logo">
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span>{{ game }}</span>
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </nav>
        
        <main class="main-content">
            <header class="page-header">
                <h1>NFL Player Props Dashboard</h1>
                <div class="controls-container">
                    <input type="text" id="playerSearch" name="player_search" class="search-box" placeholder="&#128269; Search players..." value="{{ player_search or '' }}">
                    <select id="propFilter" name="prop_filter" class="prop-select filter-dropdown-btn">
                        <option value="">All Prop Types</option>
                        {% for prop in prop_types %}
                            <option value="{{ prop }}" {% if prop == prop_filter %}selected{% endif %}>{{ prop }}</option>
                        {% endfor %}
                    </select>
                    <a href="{{ url_for('show_week', week_num=current_week) }}" class="btn btn-secondary">Reset</a>
                    
                    {% if available_weeks %}
                    <div class="week-selector-container">
                        <label for="weekSelector" class="secondary-text">View:</label>
                        <select id="weekSelector" class="filter-dropdown-btn">
                            {% for week in available_weeks %}
                                <option value="{{ week }}" {% if week == current_week %}selected{% endif %}>
                                    Week {{ week }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>
            </header>
            
            {% if error_msg %}<p style="color: #ff4d4d; text-align: center;">{{ error_msg }}</p>{% endif %}

            <section id="arbitrage-section" class="content-section">
                <div class="section-header collapsed" data-toggle="collapse" data-target="#arbitrage-content">
                    <h2>Arbitrage <span class="badge">{{ arbitrage_ops|length }}</span></h2>
                    <span class="toggle-icon">❯</span>
                </div>
                <div id="arbitrage-content" class="section-content hidden">
                    {% if not arbitrage_ops %}<p style="padding: 15px;">No arbitrage opportunities found.</p>{% endif %}
                </div>
            </section>

            <section id="value-section" class="content-section">
                <div class="section-header collapsed" data-toggle="collapse" data-target="#value-content">
                    <h2>Prop Value Finder <span class="badge" style="background-color: #3b82f6;">{{ value_bets.odds_shopping|length + value_bets.line_shopping|length }}</span></h2>
                    <span class="toggle-icon">❯</span>
                </div>
                <div id="value-content" class="section-content hidden" style="padding: 15px;">
                    
                    <h3 style="color: var(--accent-color); margin-top: 0;">Line Discrepancies (Middles)</h3>
                    <p style="color: var(--secondary-text); font-size: 0.9em; margin-top: -10px; margin-bottom: 15px;">
                        These props have different lines at different books. Betting the "Over" on the low line and "Under" on the high line creates a "middle" opportunity.
                    </p>
                    {% if not value_bets.line_shopping %}
                        <p style="color: var(--secondary-text); font-size: 0.9em;">No significant line discrepancies found.</p>
                    {% else %}
                        <div class="table-wrapper" style="margin-bottom: 20px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Player / Prop</th>
                                        <th>Bet Over (Low Line)</th>
                                        <th>Bet Under (High Line)</th>
                                        <th>Middle Size</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for op in value_bets.line_shopping %}
                                    <tr>
                                        <td>
                                            <strong>{{ op.player_name }}</strong><br>
                                            <small style="color: var(--secondary-text);">{{ op.prop_type }}</small>
                                        </td>
                                        <td>
                                            <span class="line">O {{ op.bet_over_line }}</span> 
                                            <span class="odds best-odd" style="font-size: 1em;">{{ op.bet_over_odds }}</span>
                                            <br><small style="color: var(--secondary-text);">on {{ op.bet_over_book }}</small>
                                        </td>
                                        <td>
                                            <span class="line">U {{ op.bet_under_line }}</span> 
                                            <span class="odds best-odd" style="font-size: 1em;">{{ op.bet_under_odds }}</span>
                                            <br><small style="color: var(--secondary-text);">on {{ op.bet_under_book }}</small>
                                        </td>
                                        <td>{{ op.line_diff|round(1) }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}

                    <hr style="border-color: var(--border-color); margin: 25px 0;">

                    <h3 style="color: var(--accent-color);">Best Odds (Value)</h3>
                    <p style="color: var(--secondary-text); font-size: 0.9em; margin-top: -10px; margin-bottom: 15px;">
                        These props have the same line but a significant difference in odds. The "Best Bet" has the highest payout (e.g., -110 is better than -130).
                    </p>
                    {% if not value_bets.odds_shopping %}
                        <p style="color: var(--secondary-text); font-size: 0.9em;">No significant odds discrepancies found.</p>
                    {% else %}
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Player / Prop</th>
                                        <th>Line</th>
                                        <th>Bet Type</th>
                                        <th>Best Bet</th>
                                        <th>Worst Odds (for reference)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for op in value_bets.odds_shopping %}
                                    <tr>
                                        <td>
                                            <strong>{{ op.player_name }}</strong><br>
                                            <small style="color: var(--secondary-text);">{{ op.prop_type }}</small>
                                        </td>
                                        <td>{{ op.line }}</td>
                                        <td><span class="line">{{ op.type }}</span></td>
                                        <td>
                                            <span class="odds best-odd" style="font-size: 1em;">{{ op.best_odds }}</span>
                                            <br><small style="color: var(--secondary-text);">on {{ op.best_book }}</small>
                                        </td>
                                        <td>
                                            <span class="odds" style="color: var(--secondary-text);">{{ op.worst_odds }}</span>
                                            <br><small style="color: var(--secondary-text);">on {{ op.worst_book }}</small>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}

                </div>
            </section>
            
            <section id="linemove-section" class="content-section">
                <div class="section-header collapsed" data-toggle="collapse" data-target="#linemove-content">
                    <h2>Line Movement <span class="badge" style="background-color: #f0ad4e;">{{ biggest_moves|length }}</span></h2>
                    <span class="toggle-icon">❯</span>
                </div>
                <div id="linemove-content" class="section-content hidden" style="padding: 15px;">
                    <p style="color: var(--secondary-text); font-size: 0.9em; margin-top: 0; margin-bottom: 15px;">
                        Props with the largest line changes from their first recorded value to their most recent. This requires history files (e.g., Week 7+ data).
                    </p>
                    {% if not biggest_moves %}
                        <p style="color: var(--secondary-text); font-size: 0.9em;">No significant line movement data found. This feature requires prop history files.</p>
                    {% else %}
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Player / Prop</th>
                                        <th>Sportsbook</th>
                                        <th>Start Line</th>
                                        <th>End Line</th>
                                        <th>Change</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for move in biggest_moves %}
                                    <tr>
                                        <td>
                                            <strong>{{ move.player_name }}</strong><br>
                                            <small style="color: var(--secondary-text);">{{ move.prop_type }}</small>
                                        </td>
                                        <td>{{ move.sportsbook }}</td>
                                        <td>
                                            <span class="line">{{ move.start_line }}</span><br>
                                            <small style="color: var(--secondary-text);">{{ move.start_time }}</small>
                                        </td>
                                        <td>
                                            <span class="line">{{ move.end_line }}</span><br>
                                            <small style="color: var(--secondary-text);">{{ move.end_time }}</small>
                                        </td>
                                        <td>
                                            {% set change_val = move.line_change|round(1) %}
                                            {% if change_val > 0 %}
                                                <span style="color: var(--indicator-up-color); font-weight: bold;">+{{ change_val }} &#9650;</span>
                                            {% else %}
                                                <span style="color: var(--indicator-down-color); font-weight: bold;">{{ change_val }} &#9660;</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="history-btn"
                                                    style="margin-left: 0;"
                                                    data-history='{{ move.history_json | safe }}'
                                                    data-player="{{ move.player_name }}"
                                                    data-prop-desc="{{ move.prop_type }}">
                                                History
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
            </section>
            {% for game, game_data in final_data.items()|sort %}
                <section class="game-container content-section" id="game-{{ loop.index }}">
                    <div class="section-header game-section-header"><h2>{{ game }}</h2></div>
                    <div class="section-content" style="padding:0;">
                    {% for team, team_data in game_data.teams.items()|sort %}
                        <div class="team-section">
                            <div class="team-header">{{ team }}</div>
                            <div class="player-accordions">
                            {% for player, player_data in team_data.players.items()|sort %}
                                <div class="player-accordion-item" data-player-name="{{ player|lower }}" data-props="{{ player_data.props.keys()|list|tojson|safe }}">
                                    <div class="player-header">
                                        <span class="toggle-icon">❯</span>
                                        <div><div class="player-name">{{ player }}</div></div>
                                    </div>
                                    <div class="player-props-content">
                                        <div class="table-wrapper">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Prop</th><th>Qualifier</th>
                                                        {% for book in sportsbooks %}<th>{{ book }}</th>{% endfor %}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                {% for main_prop, qualifiers in player_data.props.items()|sort %}
                                                    {% for qualifier, market_data in qualifiers.items()|sort %}
                                                        {% set best_over = namespace(value=-99999, book=None) %}{% set best_under = namespace(value=-99999, book=None) %}
                                                        {# Get history from the first book entry. We assume all books for this market share one history obj #}
                                                        {% set market_info = (market_data.values()|list)[0] %} 
                                                        {% for book in sportsbooks %}{% if book in market_data %}
                                                            {% set over_val = market_data[book].over|float(-99999) %}{% if over_val > best_over.value %}{% set best_over.value = over_val %}{% set best_over.book = book %}{% endif %}
                                                            {% set under_val = market_data[book].under|float(-99999) %}{% if under_val > best_under.value %}{% set best_under.value = under_val %}{% set best_under.book = book %}{% endif %}
                                                        {% endif %}{% endfor %}
                                                        <tr>
                                                            <td>
                                                                {{ main_prop }}
                                                                <button class="history-btn"
                                                                        data-history='{{ market_info.history | safe }}'
                                                                        data-player="{{ player }}"
                                                                        data-prop-desc="{{ main_prop }} {{ qualifier }}">
                                                                    History
                                                                </button>
                                                            </td>
                                                            <td>{{ qualifier }}</td>
                                                            {% for book in sportsbooks %}
                                                            <td class="odds-cell">
                                                                {% if book in market_data %}<span class="line">{{ market_data[book].line }}</span> <span class="odds"><span class="{% if book == best_over.book %}best-odd{% endif %}">{{ market_data[book].over }}</span>/<span class="{% if book == best_under.book %}best-odd{% endif %}">{{ market_data[book].under }}</span></span>
                                                                {% else %}&mdash;{% endif %}
                                                            </td>
                                                            {% endfor %}
                                                        </tr>
                                                    {% endfor %}
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                </section>
            {% endfor %}
             <div id="no-results-message" class="hidden" style="text-align:center; padding: 20px; color: var(--secondary-text);">
                No results found for the current filter.
            </div>
        </main>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Prop History</h2>
                <span class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                
                <div class="main-tab-nav" id="mainTabNav">
                    </div>

                <div class="main-tab-content" id="mainTabContent">
                    </div>

            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- (Unchanged) LIVE SEARCH AND FILTER SCRIPT ---
        const searchInput = document.getElementById('playerSearch');
        const propFilter = document.getElementById('propFilter');
        const noResultsMessage = document.getElementById('no-results-message');

        const applyFilters = () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const propTerm = propFilter.value;
            let totalVisiblePlayers = 0;
            document.querySelectorAll('.game-container').forEach(gameContainer => {
                let gameHasVisiblePlayers = false;
                gameContainer.querySelectorAll('.team-section').forEach(teamSection => {
                    let teamHasVisiblePlayers = false;
                    teamSection.querySelectorAll('.player-accordion-item').forEach(item => {
                        const playerName = item.dataset.playerName || '';
                        let playerProps = new Set();
                        try { playerProps = new Set(JSON.parse(item.dataset.props || '[]')); } catch(e) { console.error("Could not parse player props JSON:", item.dataset.props); }
                        const matchesSearch = !searchTerm || playerName.includes(searchTerm);
                        const matchesProp = !propTerm || playerProps.has(propTerm);
                        if (matchesSearch && matchesProp) {
                            item.style.display = ''; teamHasVisiblePlayers = true; gameHasVisiblePlayers = true; totalVisiblePlayers++;
                        } else { item.style.display = 'none'; }
                    });
                    teamSection.classList.toggle('hidden', !teamHasVisiblePlayers);
                });
                gameContainer.classList.toggle('hidden', !gameHasVisiblePlayers);
                const gameId = gameContainer.id;
                const sidebarLink = document.querySelector(`.game-nav-item[data-game-id="${gameId}"]`);
                if(sidebarLink) { sidebarLink.classList.toggle('filtered-out', !gameHasVisiblePlayers); }
            });
            noResultsMessage.classList.toggle('hidden', totalVisiblePlayers > 0);
        };
        searchInput.addEventListener('input', applyFilters);
        propFilter.addEventListener('change', applyFilters);
        if (searchInput.value || propFilter.value) { applyFilters(); }

        // --- (Unchanged) Existing Page Interactivity Scripts ---
        const weekSelector = document.getElementById('weekSelector');
        if (weekSelector) {
            weekSelector.addEventListener('change', function() {
                window.location.href = `/week/${this.value}`;
            });
        }

        const arbitrageOps = {{ arbitrage_ops|tojson }};
         document.querySelectorAll('[data-toggle="collapse"]').forEach(header => {
            const target = document.querySelector(header.dataset.target);
            if (!target) return;
            header.addEventListener('click', () => {
                header.classList.toggle('collapsed');
                target.classList.toggle('hidden');
                if (target.id === 'arbitrage-content' && !target.classList.contains('hidden') && !target.innerHTML.includes('<table>')) {
                    if (arbitrageOps && arbitrageOps.length > 0) {
                        let tableHTML = `<div class="table-wrapper" style="padding: 15px;"><table class="arbitrage-table"><thead><tr><th>Player / Prop</th><th>Bet Over</th><th>Bet Under</th><th>Profit</th></tr></thead><tbody>`;
                        arbitrageOps.forEach(op => {
                            tableHTML += `<tr>
                                <td><strong>${op.player_name}</strong><br><small style="color: var(--secondary-text);">${op.prop_type} (${op.line})</small></td>
                                <td><strong>${op.bet_on_over.odds > 0 ? '+' : ''}${op.bet_on_over.odds}</strong> on ${op.bet_on_over.sportsbook}</td>
                                <td><strong>${op.bet_on_under.odds > 0 ? '+' : ''}${op.bet_on_under.odds}</strong> on ${op.bet_on_under.sportsbook}</td>
                                <td style="color: var(--profit-color);">${op.profit_margin}</td>
                            </tr>`;
                        });
                        tableHTML += `</tbody></table></div>`;
                        target.innerHTML = tableHTML;
                    }
                }
            });
        });

        document.querySelectorAll('.player-header').forEach(header => {
            header.addEventListener('click', () => {
                header.classList.toggle('active');
                const content = header.nextElementSibling;
                if (content.style.maxHeight) { content.style.maxHeight = null; } 
                else { content.style.maxHeight = content.scrollHeight + "px"; }
            });
        });
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute('id');
                    document.querySelectorAll('.game-nav-item a').forEach(link => {
                        link.classList.toggle('active', link.getAttribute('href') === `#${id}`);
                    });
                }
            });
        }, { rootMargin: "-40% 0px -60% 0px" });
        document.querySelectorAll('.game-container').forEach(section => observer.observe(section));

        
        // ===============================================
        // === (HEAVILY MODIFIED) History Modal Script ===
        // ===============================================
        
        const modal = document.getElementById('historyModal');
        const closeModalBtn = modal.querySelector('.close-button');
        const modalTitle = document.getElementById('modalTitle');
        const mainTabNav = document.getElementById('mainTabNav');
        const mainTabContent = document.getElementById('mainTabContent');

        let activeCharts = {};       // Store multiple chart instances
        let currentHistoryData = []; // Holds the raw JSON data
        let allTimestamps = [];      // Holds all unique, sorted timestamps for the X-axis
        
        const bookColorMap = { 
            'Fanduel':    { line: '#1679f2', over: '#58a6ff', under: '#a3cfff' },
            'Draftkings': { line: '#268f44', over: '#56d364', under: '#a6f0b0' },
            'Default':    { line: '#c9d1d9', over: '#aaaaaa', under: '#888888' }
        };

        const closeModal = () => {
            modal.style.display = 'none';
            for (const chartId in activeCharts) {
                if (activeCharts[chartId]) {
                    activeCharts[chartId].destroy();
                }
            }
            activeCharts = {};
            mainTabNav.innerHTML = '';
            mainTabContent.innerHTML = '';
            currentHistoryData = [];
            allTimestamps = [];
        };

        closeModalBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                closeModal();
            }
        });

        /**
         * (NEW) Gets a specific dataset (Line, Over, or Under) for a book
         */
        const getBookDataset = (bookName, dataType) => {
            const colors = bookColorMap[bookName] || bookColorMap['Default'];
            
            const bookDataMap = new Map();
            currentHistoryData.filter(r => r.sportsbook === bookName).forEach(r => {
                bookDataMap.set(r.scrape_timestamp, r);
            });

            let data, label, color, dash, yAxisID;

            switch(dataType) {
                case 'Line':
                    data = allTimestamps.map(ts => bookDataMap.get(ts)?.line || null);
                    label = `${bookName} - Line`;
                    color = colors.line;
                    dash = [];
                    yAxisID = 'y_line'; // Use a specific ID
                    break;
                case 'Over':
                    data = allTimestamps.map(ts => bookDataMap.get(ts)?.over_odds || null);
                    label = `${bookName} - Over Odds`;
                    color = colors.over;
                    dash = [5, 5];
                    yAxisID = 'y_odds'; // Use a specific ID
                    break;
                case 'Under':
                    data = allTimestamps.map(ts => bookDataMap.get(ts)?.under_odds || null);
                    label = `${bookName} - Under Odds`;
                    color = colors.under;
                    dash = [2, 2];
                    yAxisID = 'y_odds';
                    break;
            }

            return {
                label: label, data: data,
                borderColor: color, backgroundColor: `${color}33`,
                borderDash: dash, yAxisID: yAxisID,
                tension: 0.1, spanGaps: true, borderWidth: 2.5
            };
        };
        
        /**
         * (NEW) Generic chart rendering function
         */
        const renderChart = (canvasId, datasets, yAxisConfig) => {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (activeCharts[canvasId]) {
                activeCharts[canvasId].destroy();
            }
            
            const newChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allTimestamps.map(ts => new Date(ts)),
                    datasets: datasets
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'hour', displayFormats: { hour: 'MMM d, h:mm a' } },
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        },
                        ...yAxisConfig // Spread the dynamic Y-axis config
                    },
                    plugins: {
                        legend: { labels: { color: '#c9d1d9' } },
                        tooltip: {
                            backgroundColor: '#f0f6fc',
                            titleColor: '#0d1117',
                            titleFont: { weight: 'bold' },
                            bodyColor: '#0d1117',
                            borderColor: '#30363d',
                            borderWidth: 1,
                            padding: 10,
                            cornerRadius: 6,
                            caretSize: 6,
                            callbacks: {
                                title: (context) => new Date(context[0].parsed.x).toLocaleString([], {
                                    year: 'numeric', month: 'short', day: 'numeric',
                                    hour: '2-digit', minute: '2-digit'
                                }),
                                label: (context) => {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        if (context.dataset.yAxisID === 'y_odds' && context.parsed.y > 0) {
                                            label += '+';
                                        }
                                        label += context.parsed.y;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            activeCharts[canvasId] = newChart;
        };

        /**
         * (NEW) Renders the Line Comparison chart
         */
        const renderCompareChart = (allSportsbooks) => {
            const datasets = allSportsbooks.map(book => getBookDataset(book, 'Line'));
            const yAxisConfig = {
                y_line: {
                    position: 'left',
                    title: { display: true, text: 'Line', color: '#c9d1L9' },
                    ticks: { color: '#8b949e' },
                    grid: { color: '#30363d' }
                }
            };
            renderChart('chart-Compare', datasets, yAxisConfig);
        };
        
        /**
         * (NEW) Renders the two detail charts for a single book
         */
        const renderBookDetailCharts = (bookName) => {
            // Chart 1: Line
            const lineDataset = [getBookDataset(bookName, 'Line')];
            const lineYAxisConfig = {
                y_line: {
                    position: 'left',
                    title: { display: true, text: 'Line', color: '#c9d1d9' },
                    ticks: { color: '#8b949e' },
                    grid: { color: '#30363routec' }
                }
            };
            renderChart(`chart-${bookName}-Line`, lineDataset, lineYAxisConfig);

            // Chart 2: Odds
            const oddsDatasets = [
                getBookDataset(bookName, 'Over'),
                getBookDataset(bookName, 'Under')
            ];
            const oddsYAxisConfig = {
                y_odds: {
                    position: 'left',
                    title: { display: true, text: 'Odds', color: '#c9d1d9' },
                    ticks: { color: '#8b949e' },
                    grid: { color: '#30363d' }
                }
            };
            renderChart(`chart-${bookName}-Odds`, oddsDatasets, oddsYAxisConfig);
        };
        
        // --- (Unchanged) Table-building helper functions ---
        const getChangeIndicator = (currentValue, previousValue, isOdds = false) => {
            if (previousValue === null || previousValue === undefined || currentValue == previousValue) return '';
            if (currentValue > previousValue) return '<span class="indicator indicator-up">&#9650;</span>'; // Up arrow
            return '<span class="indicator indicator-down">&#9660;</span>'; // Down arrow
        };

        const buildHistoryTable = (bookHistory) => {
            let tableHtml = '<table class="history-table"><thead><tr><th>Timestamp</th><th>Line</th><th>Over</th><th>Under</th></tr></thead><tbody>';
            // Loop backwards to show newest first
            for (let i = bookHistory.length - 1; i >= 0; i--) {
                const current = bookHistory[i];
                const previous = (i > 0) ? bookHistory[i - 1] : null;
                const lineChange = getChangeIndicator(current.line, previous?.line);
                const overChange = getChangeIndicator(current.over_odds, previous?.over_odds, true);
                const underChange = getChangeIndicator(current.under_odds, previous?.under_odds, true);
                tableHtml += `
                    <tr>
                        <td>${new Date(current.scrape_timestamp).toLocaleString()}</td>
                        <td>${current.line}${lineChange}</td>
                        <td>${current.over_odds}${overChange}</td>
                        <td>${current.under_odds}${underChange}</td>
                    </tr>`;
            }
            return tableHtml + '</tbody></table>';
        };

        // (MODIFIED) Click handler for the main "History" button
        // This *same function* now handles buttons from the main prop tables
        // AND the new line movement table.
        document.querySelectorAll('.history-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                event.stopPropagation();
                try {
                    const data = JSON.parse(event.currentTarget.dataset.history);
                    if (!data || data.length === 0) {
                        alert("No history available for this prop.");
                        return;
                    }
                    data.sort((a, b) => new Date(a.scrape_timestamp) - new Date(b.scrape_timestamp));
                    
                    // --- 1. Set global state variables ---
                    currentHistoryData = data;
                    allTimestamps = [...new Set(data.map(r => r.scrape_timestamp))].sort((a, b) => new Date(a) - new Date(b));
                    const allSportsbooks = [...new Set(data.map(r => r.sportsbook))];
                    
                    // --- 2. Set Title ---
                    modalTitle.textContent = `${event.currentTarget.dataset.player} - ${event.currentTarget.dataset.propDesc}`;
                    
                    // --- 3. (NEW) Dynamically build Master Tabs, Panes, Charts, and Tables ---
                    mainTabNav.innerHTML = '';
                    mainTabContent.innerHTML = '';
                    activeCharts = {};

                    // a. Create "Line Comparison" Tab (Always first)
                    const compareBtn = document.createElement('button');
                    compareBtn.className = 'main-tab-btn active'; // Active by default
                    compareBtn.dataset.target = 'pane-Compare';
                    compareBtn.textContent = 'Line Comparison';
                    mainTabNav.appendChild(compareBtn);

                    const comparePane = document.createElement('div');
                    comparePane.className = 'main-tab-pane active'; // Active by default
                    comparePane.id = 'pane-Compare';
                    comparePane.innerHTML = `
                        <div class="chart-container">
                            <canvas id="chart-Compare"></canvas>
                        </div>
                    `;
                    mainTabContent.appendChild(comparePane);

                    // b. Create Tabs for each book
                    allSportsbooks.forEach(book => {
                        const bookHistory = data.filter(r => r.sportsbook === book);
                        if (bookHistory.length === 0) return;

                        const tabBtn = document.createElement('button');
                        tabBtn.className = 'main-tab-btn';
                        tabBtn.dataset.target = `pane-${book}`;
                        tabBtn.textContent = book;
                        
                        const pane = document.createElement('div');
                        pane.className = 'main-tab-pane';
                        pane.id = `pane-${book}`;
                        
                        pane.innerHTML = `
                            <div class="pane-chart-wrapper">
                                <div>
                                    <div class="chart-title">${book} Line Movement</div>
                                    <div class="chart-container">
                                        <canvas id="chart-${book}-Line"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <div class="chart-title">${book} Odds Movement</div>
                                    <div class="chart-container">
                                        <canvas id="chart-${book}-Odds"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="table-wrapper">
                                ${buildHistoryTable(bookHistory)}
                            </div>
                        `;
                        
                        mainTabNav.appendChild(tabBtn);
                        mainTabContent.appendChild(pane);
                    });

                    // --- 4. Render charts *after* canvases are in the DOM ---
                    renderCompareChart(allSportsbooks);
                    allSportsbooks.forEach(book => {
                        if (document.getElementById(`chart-${book}-Line`)) {
                            renderBookDetailCharts(book);
                        }
                    });

                    // --- 5. Show Modal ---
                    modal.style.display = 'block';

                } catch (e) {
                    console.error("Failed to parse or display history data:", e);
                    alert("Could not load history data.");
                }
            });
        });

        // (Unchanged) Event listener for the *main* tab navigation
        mainTabNav.addEventListener('click', (event) => {
            if (event.target.classList.contains('main-tab-btn')) {
                const targetId = event.target.dataset.target;
                
                mainTabNav.querySelectorAll('.main-tab-btn').forEach(btn => btn.classList.remove('active'));
                mainTabContent.querySelectorAll('.main-tab-pane').forEach(pane => pane.classList.remove('active'));
                
                event.target.classList.add('active');
                document.getElementById(targetId).classList.add('active');
            }
        });
    });
    </script>
</body>
</html>
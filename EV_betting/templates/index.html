<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Player Props Dashboard - Week {{ week_number }}</title>
    <style>
        /*
        ========================================
        V6.2 - DYNAMIC WEEK SELECTOR
        Author: Gemini (Senior UI/UX Engineer)
        Date: 2025-10-14
        Description: Added week navigation and dynamic data loading.
        ========================================
        */

        :root {
            --bg-color: #0d1117;
            --surface-color: #161b22;
            --header-bg: #21262d;
            --border-color: #30363d;
            --primary-text: #c9d1d9;
            --secondary-text: #8b949e;
            --accent-color: #58a6ff;
            --best-odd-bg: #234c31;
            --best-odd-text: #56d364;
            --profit-color: #56d364;
            --hover-color: #2a3038;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-radius: 6px;
        }

        html { scroll-behavior: smooth; }
        body { font-family: var(--font-family); margin: 0; background-color: var(--bg-color); color: var(--primary-text); }

        .dashboard-container { display: flex; max-width: 1600px; margin: 0 auto; }

        /* --- 1. Sidebar Navigation --- */
        .sidebar { width: 280px; height: 100vh; position: sticky; top: 0; background-color: var(--surface-color); border-right: 1px solid var(--border-color); padding: 20px 0; overflow-y: auto; flex-shrink: 0; }
        .sidebar-header { padding: 0 20px 15px 20px; font-size: 1.2em; font-weight: bold; border-bottom: 1px solid var(--border-color); }
        .game-nav-list { list-style: none; padding: 0; margin: 10px 0 0 0; }
        .game-nav-item a { display: flex; align-items: center; gap: 10px; padding: 12px 20px; color: var(--secondary-text); text-decoration: none; font-size: 0.9em; border-left: 3px solid transparent; transition: all 0.2s; }
        .game-nav-item a:hover { background-color: var(--hover-color); color: var(--primary-text); }
        .game-nav-item a.active { background-color: #2d405d; color: #fff; font-weight: bold; border-left-color: var(--accent-color); }
        .game-nav-item a.filtered-out { opacity: 0.4; pointer-events: none; }
        .game-nav-logos { display: flex; align-items: center; }
        .game-nav-logos img, .game-nav-logos svg { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; background-color: #2a3038;}
        .game-nav-logos > *:first-child { margin-right: -8px; }
        .placeholder-icon { fill: var(--secondary-text); }

        /* --- 2. Main Content & Header Controls --- */
        .main-content { flex-grow: 1; padding: 20px 30px; min-width: 0; }
        .page-header { margin-bottom: 25px; }
        .page-header h1 { margin: 0 0 20px 0; }
        .controls-container { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .search-box { padding: 8px 12px; max-width: 300px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--primary-text); font-size: 0.9em; }
        .filter-dropdown { position: relative; }
        .filter-dropdown-btn { background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--primary-text); padding: 8px 12px; border-radius: var(--border-radius); cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .filter-dropdown-btn .count { background-color: var(--accent-color); color: white; border-radius: 10px; padding: 1px 6px; font-size: 0.8em; margin-left: 5px; }
        .filter-dropdown-content { display: none; position: absolute; background-color: var(--header-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); z-index: 100; min-width: 250px; max-height: 300px; overflow-y: auto; padding: 5px; }
        .filter-dropdown-content.show { display: block; }
        .filter-dropdown-content label { display: block; padding: 8px 12px; cursor: pointer; border-radius: 4px; font-size: 0.9em;}
        .filter-dropdown-content label:hover { background-color: var(--hover-color); }
        .filter-dropdown-content input { margin-right: 10px; }
        
        /* New styles for week selector */
        .week-selector-container { display: flex; align-items: center; gap: 8px; margin-left: auto; }
        #weekSelector { -webkit-appearance: none; appearance: none; padding-right: 30px; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236e7681' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }

        /* --- 3. Arbitrage, Game & Team Containers --- */
        .content-section { border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 25px; background-color: var(--surface-color); }
        .game-container, .team-section { transition: max-height 0.4s ease-in-out, margin 0.4s, padding 0.4s; overflow: hidden; }
        .game-container.hidden, .team-section.hidden { max-height: 0 !important; margin-top: 0; margin-bottom: 0; padding-top: 0; padding-bottom: 0; border: none; }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--header-bg); cursor: pointer;}
        .section-header h2 { margin: 0; font-size: 1.5em; }
        .toggle-icon { font-size: 1.5em; transition: transform 0.3s ease-in-out; }
        .section-header.collapsed .toggle-icon { transform: rotate(-90deg); }
        .section-content { overflow: hidden; max-height: 5000px; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out; }
        .section-content.hidden { max-height: 0; padding: 0 20px; }
        .badge { background-color: var(--secondary-text); color: var(--bg-color); font-size: 0.7em; font-weight: bold; padding: 3px 8px; border-radius: 10px; margin-left: 10px; }
        #arbitrage-section .section-header .badge { background-color: var(--profit-color); }
        .game-section-header { cursor: default; }

        /* --- 4. Player Accordion --- */
        .team-header { padding: 15px 20px; font-size: 1.3em; font-weight: bold; border-top: 1px solid var(--border-color); background: #1a222e; }
        .player-accordion-item { border-top: 1px solid var(--border-color); }
        .player-header { display: flex; align-items: center; gap: 15px; padding: 12px 20px; cursor: pointer; transition: background-color 0.2s; }
        .player-header:hover { background-color: var(--hover-color); }
        .player-header .toggle-icon { font-size: 1.1em; transform: rotate(-90deg); transition: transform 0.3s ease-out; }
        .player-header.active .toggle-icon { transform: rotate(0deg); }
        .player-name { font-weight: bold; font-size: 1.1em; }
        .player-team { font-size: 0.9em; color: var(--secondary-text); }
        .player-props-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: var(--bg-color); }
        .player-props-content .table-wrapper { padding: 15px; overflow-x: auto;}

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        th { font-size: 0.8em; color: var(--secondary-text); }
        .odds-cell { text-align: center; }
        .line { font-weight: bold; }
        .odds { font-size: 0.9em; color: var(--secondary-text); }
        .best-odd { background-color: var(--best-odd-bg); color: var(--best-odd-text); font-weight: bold; border-radius: 4px; padding: 2px 4px; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="sidebar-header">Games - Week {{ week_number }}</div>
            <ul class="game-nav-list">
                {% for game, game_data in final_data.items()|sort %}
                    <li class="game-nav-item">
                        <a href="#game-{{ loop.index }}" data-target-id="game-{{ loop.index }}">
                            <div class="game-nav-logos">
                                {% set logos = namespace(items=[]) %}
                                {% for team, t_data in game_data.teams.items() %}{% set logos.items = logos.items + [t_data.logo or 'placeholder'] %}{% endfor %}
                                {% for logo_url in logos.items[:2] %}
                                    {% if logo_url == 'placeholder' %}
                                        <svg class="placeholder-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,1.5A10.5,10.5,0,0,0,1.5,12A10.5,10.5,0,0,0,12,22.5A10.5,10.5,0,0,0,22.5,12A10.5,10.5,0,0,0,12,1.5M12,3A9,9,0,0,1,21,12C21,14.63,19.78,16.94,18,18.45V12A6,6,0,0,0,12,6A6,6,0,0,0,6,12V18.45C4.22,16.94,3,14.63,3,12A9,9,0,0,1,12,3M6,20A7.5,7.5,0,0,0,12,21A7.5,7.5,0,0,0,18,20V12A6,6,0,0,0,12,6A6,6,0,0,0,6,12V20Z"></path></svg>
                                    {% else %}
                                        <img src="{{ logo_url }}" alt="Team Logo">
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span>{{ game }}</span>
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </nav>
        
        <main class="main-content">
            <header class="page-header">
                <h1>NFL Player Props Dashboard</h1>
                <div class="controls-container">
                    <input type="text" id="playerSearch" class="search-box" placeholder="🔍 Search players...">
                    <div class="filter-dropdown">
                        <button id="filterBtn" class="filter-dropdown-btn">Filter by Prop</button>
                        <div id="propFilterDropdown" class="filter-dropdown-content"></div>
                    </div>
                    {% if available_weeks %}
                    <div class="week-selector-container">
                        <label for="weekSelector" class="secondary-text">View:</label>
                        <select id="weekSelector" class="filter-dropdown-btn">
                            {% for week in available_weeks %}
                                <option value="{{ week }}" {% if week == current_week %}selected{% endif %}>
                                    Week {{ week }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>
            </header>
            
            <!-- Display error message if any -->
            {% if error_msg %}
                <p style="color: #ff4d4d; text-align: center;">{{ error_msg }}</p>
            {% endif %}

            <section id="arbitrage-section" class="content-section">
                <div class="section-header collapsed" data-toggle="collapse" data-target="#arbitrage-content">
                    <h2>Arbitrage <span class="badge">{{ arbitrage_ops|length }}</span></h2>
                    <span class="toggle-icon">▼</span>
                </div>
                <div id="arbitrage-content" class="section-content hidden">
                    {% if not arbitrage_ops %}<p style="padding: 15px;">No arbitrage opportunities found in the current data.</p>{% endif %}
                </div>
            </section>

            {% for game, game_data in final_data.items()|sort %}
                <section class="game-container content-section" id="game-{{ loop.index }}">
                    <div class="section-header game-section-header"><h2>{{ game }}</h2></div>
                    <div class="section-content" style="padding:0;">
                    {% for team, team_data in game_data.teams.items()|sort %}
                        <div class="team-section">
                            <div class="team-header">{{ team }}</div>
                            <div class="player-accordions">
                            {% for player, player_data in team_data.players.items()|sort %}
                                <div class="player-accordion-item" data-player-name="{{ player|lower }}" data-props="{{ player_data.props.keys()|list|tojson|safe }}">
                                    <div class="player-header">
                                        <span class="toggle-icon">▼</span>
                                        <div>
                                            <div class="player-name">{{ player }}</div>
                                            <div class="player-team">{{ team }}</div>
                                        </div>
                                    </div>
                                    <div class="player-props-content">
                                        <div class="table-wrapper">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Prop</th>
                                                        <th>Qualifier</th>
                                                        {% for book in sportsbooks %}<th>{{ book }}</th>{% endfor %}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                {% for main_prop, qualifiers in player_data.props.items()|sort %}
                                                    {% for qualifier, market_data in qualifiers.items()|sort %}
                                                        {% set best_over = namespace(value=-99999, book=None) %}{% set best_under = namespace(value=-99999, book=None) %}
                                                        {% for book in sportsbooks %}
                                                            {% if book in market_data %}
                                                                {% set over_val = market_data[book].over|float(-99999) %}{% if over_val > best_over.value %}{% set best_over.value = over_val %}{% set best_over.book = book %}{% endif %}
                                                                {% set under_val = market_data[book].under|float(-99999) %}{% if under_val > best_under.value %}{% set best_under.value = under_val %}{% set best_under.book = book %}{% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                        <tr>
                                                            <td>{{ main_prop }}</td>
                                                            <td>{{ qualifier }}</td>
                                                            {% for book in sportsbooks %}
                                                            <td class="odds-cell">
                                                                {% if book in market_data %}<span class="line">{{ market_data[book].line }}</span> <span class="odds"><span class="{% if book == best_over.book %}best-odd{% endif %}">{{ market_data[book].over }}</span>/<span class="{% if book == best_under.book %}best-odd{% endif %}">{{ market_data[book].under }}</span></span>
                                                                {% else %}—{% endif %}
                                                            </td>
                                                            {% endfor %}
                                                        </tr>
                                                    {% endfor %}
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                </section>
            {% endfor %}
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 0. Week Selector Logic ---
        const weekSelector = document.getElementById('weekSelector');
        if (weekSelector) {
            weekSelector.addEventListener('change', function() {
                const selectedWeek = this.value;
                window.location.href = `/week/${selectedWeek}`;
            });
        }

        // --- 1. Arbitrage Data & Section Logic ---
        const arbitrageOps = {{ arbitrage_ops|tojson }};
         document.querySelectorAll('[data-toggle="collapse"]').forEach(header => {
            const target = document.querySelector(header.dataset.target);
            if (!target) return;
            header.addEventListener('click', () => {
                header.classList.toggle('collapsed');
                target.classList.toggle('hidden');
                
                if (target.id === 'arbitrage-content' && !target.classList.contains('hidden') && !target.innerHTML.includes('<table>')) {
                    if (arbitrageOps && arbitrageOps.length > 0) {
                        let tableHTML = `<div class="table-wrapper" style="padding: 15px;"><table class="arbitrage-table"><thead><tr><th>Player / Prop</th><th>Bet Over</th><th>Bet Under</th><th>Profit</th></tr></thead><tbody>`;
                        arbitrageOps.forEach(op => {
                            tableHTML += `<tr>
                                <td><strong>${op.player_name}</strong><br><small style="color: var(--secondary-text);">${op.prop_type} (${op.line})</small></td>
                                <td><strong>${op.bet_on_over.odds > 0 ? '+' : ''}${op.bet_on_over.odds}</strong> on ${op.bet_on_over.sportsbook}</td>
                                <td><strong>${op.bet_on_under.odds > 0 ? '+' : ''}${op.bet_on_under.odds}</strong> on ${op.bet_on_under.sportsbook}</td>
                                <td style="color: var(--profit-color);">${op.profit_margin}</td>
                            </tr>`;
                        });
                        tableHTML += `</tbody></table></div>`;
                        target.innerHTML = tableHTML;
                    }
                }
            });
        });

        // --- 2. Intelligent Filtering Logic ---
        const searchInput = document.getElementById('playerSearch');
        const filterBtn = document.getElementById('filterBtn');
        const propFilterDropdown = document.getElementById('propFilterDropdown');
        let activePropTypes = new Set();
        let propTypes = new Set();
        document.querySelectorAll('.player-accordion-item').forEach(item => {
            if (item.dataset.props) {
                try { JSON.parse(item.dataset.props).forEach(prop => propTypes.add(prop)); } catch (e) { console.error("Could not parse props:", e); }
            }
        });
        Array.from(propTypes).sort().forEach(prop => {
            propFilterDropdown.innerHTML += `<label><input type="checkbox" data-prop="${prop}"> ${prop}</label>`;
        });
        const applyFilters = () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            document.querySelectorAll('.game-container').forEach(gameContainer => {
                let gameHasVisiblePlayers = false;
                gameContainer.querySelectorAll('.team-section').forEach(teamSection => {
                    let teamHasVisiblePlayers = false;
                    teamSection.querySelectorAll('.player-accordion-item').forEach(item => {
                        const playerName = item.dataset.playerName || '';
                        const playerProps = new Set(JSON.parse(item.dataset.props || '[]'));
                        const matchesSearch = !searchTerm || playerName.includes(searchTerm);
                        const matchesProp = activePropTypes.size === 0 || [...activePropTypes].some(p => playerProps.has(p));
                        if (matchesSearch && matchesProp) {
                            item.style.display = ''; teamHasVisiblePlayers = true; gameHasVisiblePlayers = true;
                        } else { item.style.display = 'none'; }
                    });
                    teamSection.classList.toggle('hidden', !teamHasVisiblePlayers);
                });
                gameContainer.classList.toggle('hidden', !gameHasVisiblePlayers);
                const gameId = gameContainer.id;
                const sidebarLink = document.querySelector(`.game-nav-item a[href="#${gameId}"]`);
                if(sidebarLink) sidebarLink.classList.toggle('filtered-out', !gameHasVisiblePlayers);
            });
        };
        searchInput.addEventListener('input', applyFilters);
        propFilterDropdown.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const prop = e.target.dataset.prop;
                if (e.target.checked) activePropTypes.add(prop); else activePropTypes.delete(prop);
                const count = activePropTypes.size;
                filterBtn.innerHTML = `Filter by Prop ${count > 0 ? `<span class="count">${count}</span>` : ''}`;
                applyFilters();
            }
        });

        // --- 3. Player Accordion Logic ---
        document.querySelectorAll('.player-header').forEach(header => {
            header.addEventListener('click', () => {
                header.classList.toggle('active');
                const content = header.nextElementSibling;
                if (content.style.maxHeight) { content.style.maxHeight = null; } 
                else { content.style.maxHeight = content.scrollHeight + "px"; }
            });
        });
        
        // --- 4. Misc Event Listeners ---
        filterBtn.addEventListener('click', (e) => { e.stopPropagation(); propFilterDropdown.classList.toggle('show'); });
        window.addEventListener('click', () => propFilterDropdown.classList.remove('show'));
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute('id');
                    document.querySelectorAll('.game-nav-item a').forEach(link => {
                        link.classList.toggle('active', link.getAttribute('href') === `#${id}`);
                    });
                }
            });
        }, { rootMargin: "-40% 0px -60% 0px" });
        document.querySelectorAll('.game-container').forEach(section => observer.observe(section));
    });
    </script>
</body>
</html>
